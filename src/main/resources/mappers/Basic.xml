<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thekiban.Mapper.BasicMapper">
	<!-- 세부정보 조회 -->
	<select id="SelectDetail" resultType="Detail">
		SELECT * FROM detail
		WHERE detail_type = 1
	</select>

	<!-- 원종 갯수 조회 -->
	<select id="SelectBasicCount" resultType="int">
		SELECT COUNT(*) FROM basic
		<choose>
			<when test="basic_name != 'none'">
				WHERE basic_name = #{basic_name}
			</when>
		</choose>
	</select>
	
	<!-- 원종 검색 -->
	<select id="SearchBasic" resultType="Basic">
		SELECT *,
		(SELECT COUNT(*) FROM standard s LEFT JOIN detail d ON s.detail_id = d.detail_id WHERE s.basic_id = b.basic_id AND d.detail_origin = 1 AND s.standard IS NOT NULL) AS standard_count
		FROM basic b
		<choose>
			<when test="basic_name != 'none'">
				WHERE b.basic_name = #{basic_name}
			</when>
		</choose>
		ORDER BY b.basic_id DESC
		LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 원종별 세부 정보 조회 -->
    <select id="SearchBasicDetail" parameterType="String" resultType="Detail">
    	SELECT * FROM detail
    	WHERE detail_type = 0 AND detail_name = #{basic_name}
    </select>
    
    <!-- 표시항목 조회 -->
    <select id="SelectDisplay" resultType="Display">
    	SELECT * FROM display dp
		LEFT JOIN detail dt ON dp.detail_id = dt.detail_id
    	WHERE dp.user_id = #{user_id} AND dp.basic_name = #{basic_name}
    </select>
    
    <!-- 원종별 정보값 조회 -->
    <select id="SearchBasicStandard" resultType="Standard">
    	SELECT * FROM standard s
		LEFT JOIN detail d ON s.detail_id = d.detail_id
		LEFT JOIN display dp ON d.detail_id = dp.detail_id
    	WHERE s.basic_id = #{basic_id} AND dp.user_id = #{user_id}
    	<foreach collection="detail" item="item" open="AND (" close=")" separator="OR">
            dp.detail_id = #{item.detail_id}
        </foreach>
    </select>

	<!-- 원종 등록 -->
	<insert id="InsertBasic" parameterType="Basic">
		INSERT INTO basic
		(basic_name, create_date, modify_date)
		VALUES
		(#{basic_name}, NOW(), NOW())
		<selectKey resultType="int" keyProperty="basic_id" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
    </insert>

    <!-- 원종 상세 정보 등록 -->
    <insert id="InsertStandard" parameterType="java.util.ArrayList">
        <foreach collection="detail" item="item" separator=";">
        	<choose>
        		<when test="item.detail_title == '작물'">
		            INSERT INTO standard
		            (detail_id, basic_id, standard)
		            VALUES
		            (#{item.detail_id}, #{basic_id}, #{basic_name})
        		</when>
        		<when test="item.detail_title != '작물'">
		            INSERT INTO standard
		            (detail_id, basic_id)
		            VALUES
		            (#{item.detail_id}, #{basic_id})
        		</when>
        	</choose>
        </foreach>
    </insert>
    
    <!-- 원종별 전체 조회 -->
    <select id="SelectBasicAll" resultType="Basic">
    	SELECT *,
    	(SELECT COUNT(*) FROM standard s LEFT JOIN detail d ON s.detail_id = d.detail_id WHERE s.basic_id = b.basic_id AND d.detail_origin = 1 AND s.standard IS NOT NULL) AS standard_count
    	FROM basic b
    	WHERE b.basic_name = #{basic_name}
    	ORDER BY b.basic_id DESC
    	LIMIT #{offset}, 10
    </select>
    
    <!-- 원종별 정보 전체 조회 -->
    <select id="SelectBasicStandard" parameterType="int" resultType="Standard">
    	SELECT * FROM standard
    	WHERE basic_id = #{basic_id}
    </select>

	<!-- 원종 수정 -->
	<update id="UpdateBasic">
		UPDATE standard
		SET standard = #{standard}
		WHERE basic_id = #{basic_id} AND detail_id = #{detail_id} 
    </update>
        
    <!-- 원종 전체 수정 -->
    <update id="UpdateAllBasic" parameterType="java.util.ArrayList">
        <foreach collection="list" item="item" separator=";">
	    	UPDATE standard
	    	SET standard = #{item.standard}
	    	WHERE basic_id = #{item.basic_id} AND detail_id = #{item.detail_id}
    	</foreach>
    </update>

    <!-- 원종 삭제 -->
    <select id="DeleteBasic" parameterType="java.util.ArrayList">
        DELETE FROM basic
        WHERE
        <foreach collection="array" item="item" open="(" close=")" separator="OR">
            basic_id = #{item}
        </foreach>
    </select>
    
    <!-- 원종 값 삭제 -->
    <select id="DeleteStandard" parameterType="java.util.ArrayList">
        DELETE FROM standard
        WHERE
        <foreach collection="array" item="item" open="(" close=")" separator="OR">
            basic_id = #{item}
        </foreach>
    </select>
    
    <!-- 표시항목 삭제 -->
    <delete id="DeleteDisplay" parameterType="int">
    	DELETE FROM display
    	WHERE user_id = #{user_id}
    </delete>
    
    <!-- 표시항목 등록 -->
    <insert id="InsertDisplay">
    	<foreach collection="detail_list" item="item" separator=";">
	    	INSERT INTO display
	    	(user_id, basic_name, detail_id)
	    	VALUES
	    	(#{user_id}, #{basic_name}, #{item})
        </foreach>
    </insert>
</mapper>