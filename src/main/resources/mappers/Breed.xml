<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thekiban.Mapper.BreedMapper">
    <!-- 세부정보 조회 -->
    <select id="SelectDetail" resultType="Detail">
        SELECT * FROM detail
        WHERE detail_type = 0
    </select>

    <!-- 품종 갯수 조회 -->
    <select id="SelectBreedCount" resultType="int">
        SELECT COUNT(*) FROM breed
        <choose>
            <when test="breed_name != 'none'">
                WHERE breed_name = #{breed_name}
            </when>
        </choose>
    </select>

    <!-- 품종 검색 -->
    <select id="SearchBreed" resultType="Breed">
        SELECT *,
        (SELECT COUNT(*) FROM standard s LEFT JOIN detail d ON s.detail_id = d.detail_id WHERE s.breed_id = b.breed_id AND d.detail_origin = 1 AND s.standard IS NOT NULL) AS standard_count
        FROM breed b
        <choose>
            <when test="breed_name != 'none'">
                WHERE b.breed_name = #{breed_name}
            </when>
        </choose>
        ORDER BY b.breed_id DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 품종별 세부 정보 조회 -->
    <select id="SearchBreedDetail" parameterType="String" resultType="Detail">
    	SELECT * FROM detail
    	WHERE detail_type = 0 AND detail_name = #{breed_name}
    </select>
    
    <!-- 표시항목 조회 -->
    <select id="SelectDisplay" resultType="Display">
    	SELECT * FROM display dp
		LEFT JOIN detail dt ON dp.detail_id = dt.detail_id
    	WHERE dp.user_id = #{user_id} AND dp.breed_name = #{breed_name}
    </select>
    
    <!-- 품종별 정보값 조회 -->
    <select id="SearchBreedStandard" resultType="Standard">
    	SELECT * FROM standard s
		LEFT JOIN detail d ON s.detail_id = d.detail_id
		LEFT JOIN display dp ON d.detail_id = dp.detail_id
    	WHERE s.breed_id = #{breed_id} AND dp.user_id = #{user_id}
    	<foreach collection="detail" item="item" open="AND (" close=")" separator="OR">
            dp.detail_id = #{item.detail_id}
        </foreach>
    </select>

    <!-- 품종 등록 -->
    <insert id="InsertBreed" parameterType="Breed">
        INSERT INTO breed
        (breed_name, create_date, modify_date)
        VALUES
        (#{breed_name}, NOW(), NOW())
        <selectKey resultType="int" keyProperty="breed_id" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <!-- 품종 상세 정보 등록 -->
    <insert id="InsertStandard" parameterType="java.util.ArrayList">
        <foreach collection="detail" item="item" separator=";">
        	<choose>
        		<when test="item.detail_title == '작물'">
		            INSERT INTO standard
		            (detail_id, breed_id, standard)
		            VALUES
		            (#{item.detail_id}, #{breed_id}, #{breed_name})
        		</when>
        		<when test="item.detail_title != '작물'">
		            INSERT INTO standard
		            (detail_id, breed_id)
		            VALUES
		            (#{item.detail_id}, #{breed_id})
        		</when>
        	</choose>
        </foreach>
    </insert>
    
    <!-- 품종별 전체 조회 -->
    <select id="SelectBreedAll" resultType="Breed">
    	SELECT *,
    	(SELECT COUNT(*) FROM standard s LEFT JOIN detail d ON s.detail_id = d.detail_id WHERE s.breed_id = b.breed_id AND d.detail_origin = 1 AND s.standard IS NOT NULL) AS standard_count
    	FROM breed b
    	WHERE b.breed_name = #{breed_name}
    	ORDER BY b.breed_id DESC
    	LIMIT #{offset}, 10
    </select>
    
    <!-- 품종별 정보 전체 조회 -->
    <select id="SelectBreedStandard" parameterType="int" resultType="Standard">
    	SELECT * FROM standard
    	WHERE breed_id = #{breed_id}
    </select>
    
    <!-- 품종 수정 -->
    <update id="UpdateBreed">
    	UPDATE standard
    	SET standard = #{standard}
    	WHERE breed_id = #{breed_id} AND detail_id = #{detail_id} 
    </update>
    
    <!-- 품종 전체 수정 -->
    <update id="UpdateAllBreed" parameterType="java.util.ArrayList">
        <foreach collection="list" item="item" separator=";">
	    	UPDATE standard
	    	SET standard = #{item.standard}
	    	WHERE breed_id = #{item.breed_id} AND detail_id = #{item.detail_id}
    	</foreach>
    </update>

    <!-- 품종 삭제 -->
    <select id="DeleteBreed" parameterType="java.util.ArrayList">
        DELETE FROM breed
        WHERE
        <foreach collection="array" item="item" open="(" close=")" separator="OR">
            breed_id = #{item}
        </foreach>
    </select>
    
    <!-- 품종 값 삭제 -->
    <select id="DeleteStandard" parameterType="java.util.ArrayList">
        DELETE FROM standard
        WHERE
        <foreach collection="array" item="item" open="(" close=")" separator="OR">
            breed_id = #{item}
        </foreach>
    </select>
    
    <!-- 표시항목 삭제 -->
    <delete id="DeleteDisplay" parameterType="int">
    	DELETE FROM display
    	WHERE user_id = #{user_id} AND display_type = 0
    </delete>
    
    <!-- 표시항목 등록 -->
    <insert id="InsertDisplay">
    	<foreach collection="detail_list" item="item" separator=";">
	    	INSERT INTO display
	    	(user_id, breed_name, detail_id, display_type)
	    	VALUES
	    	(#{user_id}, #{breed_name}, #{item}, 0)
        </foreach>
    </insert>
</mapper>